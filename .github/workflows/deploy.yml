name: Deploy to S3

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  S3_BUCKET: venue-maps-bucket-1234567890

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Vite app
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHub_Actions_Role
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync to S3
        run: |
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.json"

          # Set shorter cache for HTML files (for SPA routing)
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }}/ \
            --cache-control "public, max-age=0, must-revalidate" \
            --include "*.html" \
            --include "*.json"

    #   - name: Invalidate CloudFront (if exists)
    #     run: |
    #       # Get CloudFront distribution ID if it exists
    #       DISTRIBUTION_ID=$(aws cloudfront list-distributions \
    #         --query "DistributionList.Items[?Origins.Items[0].DomainName==\`${{ env.S3_BUCKET }}.s3.amazonaws.com\`].Id" \
    #         --output text)

    #       if [ ! -z "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
    #         echo "Invalidating CloudFront distribution: $DISTRIBUTION_ID"
    #         aws cloudfront create-invalidation \
    #           --distribution-id $DISTRIBUTION_ID \
    #           --paths "/*"
    #       else
    #         echo "No CloudFront distribution found for this S3 bucket"
    #       fi

    #   - name: Output website URL
    #     run: |
    #       echo "Website deployed to: https://${{ env.S3_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"

    #       # If CloudFront exists, show that URL too
    #       DISTRIBUTION_ID=$(aws cloudfront list-distributions \
    #         --query "DistributionList.Items[?Origins.Items[0].DomainName==\`${{ env.S3_BUCKET }}.s3.amazonaws.com\`].Id" \
    #         --output text)

    #       if [ ! -z "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
    #         DOMAIN_NAME=$(aws cloudfront get-distribution \
    #           --id $DISTRIBUTION_ID \
    #           --query "Distribution.DomainName" \
    #           --output text)
    #         echo "CloudFront URL: https://$DOMAIN_NAME"
    #       fi
